
{% extends 'base.html' %}


{% block head %}
 <link rel="stylesheet" type="text/css" href="/static/calc_style.css">

<script src="https://code.jquery.com/jquery.js"></script>
<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
<!-- <link rel="stylesheet" typle="text/css" href="/static/style.css"> -->
{% endblock %}

{% block content %}


	<div class="user_view_wall">
		<p>
			<table>
				<tr>
				 	<th id ='wall-name'> Wall Name </th>
				 	<th id ='wall-width'> Wall Width</th>
				 	<th>Original End Margins</th>
				 	{% if art|length != 1 %}
				 		<th>Original Mid Margins</th>
				 	{% endif %}		
				 </tr>
				 <tr>
				  	<td id ='wall-name'> {{wall.wall_name}} </td>
				  	<td id ='wall-width'> {{wall.wall_width / 1000}}</td>
				  	<td id ='EMO'> _</td>
				  	<td id ='MMO'> _</td>

				  </tr>
			</table>
		<p>
	<div class="user_view_art">
		<p><table>
			<tr>
			    <th>Art Name</th>
			    <th>Origin X Peg </th>		
			    <th>Origin Y Peg </th>	
			    <th>New X Peg </th>	
			    <th>New Y Peg </th>
			    <th>Device Type </th>
			    <th>Left End Margin </th>		
			    <th>Right End Margin </th>	
			</tr>
			{% for item in art %}
			 <tr> 
				<td class="user_view_output" id="{{ item.art_name }}"> 
					{{ item.art_name }} </td>
				<td id ='{{item.art_name}}_OX'> _</td>
				<td id ='{{item.art_name}}_OY'> _</td>
				<td id ='{{item.art_name}}_X'> _</td>
				<td id ='{{item.art_name}}_Y'> _</td>  
				<td id ='{{item.art_name}}_D'> _</td> 
				<td id ='{{item.art_name}}_LEM'> _</td>  
				<td id ='{{item.art_name}}_REM'> _</td> 
			  </tr>
			{% endfor %} 
		</table>
	</div>

<div class="wall"><div>




	<script>
		var wall = ({{wall|tojson}});
		var art = ({{art|tojson}});
		var totArtWidth = 0;
		var blankWall;
		var consistantMargins;
		var midMargin;
		var endMargin;
		var p0;
		var p;
		var xAxis;
		var offset;
		var width = window.innerWidth
		var delta = window.innerWidth/wall.wall_width * wall.wall_height


		function restoreArtFloats(art){
			for(var i=0; i<art.length; i++){
				art[i].art_width = art[i].art_width / 1000;
				art[i].art_height =art[i].art_height / 1000;
				art[i].device_distance = art[i].device_distance / 1000;
			}
		}
		
		restoreArtFloats(art);


		wall.wall_width = wall.wall_width / 1000;
		wall.wall_height = wall.wall_height / 1000;
		wall.center_line = wall.center_line / 1000;
		wall.offset_percent = wall.offset_percent / 1000;


		// FIND TOTAL WIDTH OF ART
		function allArtsWidths(obj){ 
			for ( var w = 0; w < obj.length; w++ ){
			    totArtWidth += obj[w].art_width; 
			}
		} 


		// MIDDLE AND END MARGINS
		function Margins() {
			blankWall = wall.wall_width - totArtWidth; 
			consistantMargins = (blankWall / (art.length + 1));
			offset = consistantMargins * wall.offset_percent;
			midMargin = consistantMargins - offset; 
			if (art.length === 2) {
				endMargin = consistantMargins + offset / 2;
			} else if (art.length === 1){
				endMargin = consistantMargins;
				midMargin = 0;
			} else { 
				endMargin = consistantMargins + offset;
			}
		}


		// UPPER EDGE LONGITUDE OF ALL ARTS
		function upperX(obj) {
			for(var i = 0; i < obj.length; i ++){
			    var each = obj[i].art_height / 2 + wall.center_line;
			    obj[i].upperEdge = each;
			}
		}


		//LEFT CORNER COORDINATES FOR MAPPING
		function leftCornerCords(obj){
			p0 = endMargin;
			p = midMargin;
			xAxis = [p0];
			for(i=1; i<obj.length; i++){
			    xAxis[i] = xAxis[i-1] + obj[i-1].art_width + p;
			}
			for(var i = 0; i < xAxis.length; i++){
			    obj[i].leftCorner = {X : 0};
			    obj[i].leftCorner.X = xAxis[i];
			}
		}


		//"TAC POINT" FOR USER INFO
		function findPegPoint(obj){ 
			for(var i = 0; i < obj.length; i++){
			    obj[i].leftCorner.Y = obj[i].upperEdge;
			    obj[i].leftCorner.Y = Math.round(obj[i].leftCorner.Y * 100) / 100;
			    obj[i].leftCorner.X = Math.round(obj[i].leftCorner.X * 100) / 100;

			    if (obj[i].device_code === 'none'){
			        obj[i].pegPoint = {X : obj[i].leftCorner.X, 
			                                Y : obj[i].leftCorner.Y};
			    } else {
			        obj[i].pegPoint = {X : (obj[i].leftCorner.X + 
			        					  	obj[i].art_width/2),
			                              Y : (obj[i].leftCorner.Y - 
			                              	obj[i].device_distance)};
				}
			}
		}


		function dynamicRectangles(){ 	
			width = window.innerWidth / 2;
			scale = width * wall.wall_height / 2;
			width = window.innerWidth;
			scale = width * wall.wall_height
			var svg = d3.select(".wall")
										.append("svg")
		                                .attr("width", wall.wall_width)
		                                .attr("height", wall.wall_height)
		                                .style("border", "1px dashed black");

	        var drag = d3.behavior.drag()
	            .on("drag", dragMove);
		        
	        var rect = svg.selectAll(".draggableRectangle").data(art).enter()
	        		.append('image')
	        		.attr('class', 'draggableRectangle')
	        		.attr('name', function(d) { return d.art_name; })
	        		.attr('device', function(d) { return d.device_code})
	                .attr('x', function(d) { return d.leftCorner.X; })
	                .attr('y', function(d) {return wall.wall_height - d.leftCorner.Y; })

	                ///////////
	                .attr('LEM', function(d) {return wall.wall_height - d.leftCorner.Y; })
	                //////////

	                .attr('Ox', function(d) { return d.leftCorner.X; })
	                .attr('Oy', function(d) {return wall.wall_height - d.leftCorner.Y; })
	                .attr('width', function(d) { return d.art_width; })
	                .attr('height', function(d) { return d.art_height; })
	                .attr("xlink:href", function(d) { return d.art_img; })
	                .call(drag);

            function dragMove(d) {
            	//if art has hanging wire, math it in. Else return top left corner
                     d3.select(this)
                         .attr("x", function () {return d3.event.x})
                         .attr("y", function () {return d3.event.y})

                         ///////////
                         .attr("LEM", function () {return d3.event.LEM});
                         ///////////

                     var name = document.getElementById(d.art_name);
                             name.innerHTML = d.art_name;
                     
                     //drag output
                     if(d.device_code === "none"){ ;
                            var X = document.getElementById(d.art_name+"_X");
                                X.innerHTML = Math.round(d3.event.x);
                     } else { ;
                            var X = document.getElementById(d.art_name+"_X");
                                X.innerHTML = Math.round(d3.event.x + (d.art_width/2));
                     }
                     if(d.device_code === "none") { 
                            var Y = document.getElementById(d.art_name+"_Y");
                                Y.innerHTML = Math.round(wall.wall_height -d3.event.y);
                     } else { ;
                            var Y = document.getElementById(d.art_name+"_Y");
                                Y.innerHTML = Math.round((wall.wall_height -d3.event.y) - 
                                                                            d.device_distance);
                     }
                     var leftMargin = document.getElementById(d.art_name+"_LEM");
                     	leftMargin.innerHTML = Math.round( d.leftCorner.X -d3.event.LEM * 1000) /1000;


                     //original data output
                     if(d.device_code === "none"){ ;
                            var XO = document.getElementById(d.art_name+"_OX");
                                XO.innerHTML = Math.round(d.leftCorner.X * 1000) /1000;
                     } else { ;
                            var XO = document.getElementById(d.art_name+"_OX");
                                XO.innerHTML = Math.round((d.leftCorner.X + d.art_width/2) * 1000) / 1000;
                     }

                     if(d.device_code === "none") { 
                            var YO = document.getElementById(d.art_name+"_OY");
                                YO.innerHTML = Math.round(d.leftCorner.Y * 1000) /1000 ;
                     } else { ;
                            var YO = document.getElementById(d.art_name+"_OY");
                                YO.innerHTML = Math.round((d.leftCorner.Y - d.device_distance) * 1000) /1000;
                     }

		            var device = document.getElementById(d.art_name+"_D");
		                    if(d.device_code === "none") { 
		                    	device.innerHTML = "Use Left Corner";
		                } else {
		                	device.innerHTML = "Wire";
		                }
		            //Original Margins    
		            var endMarginOrigin = document.getElementById("EMO");
		            	endMarginOrigin.innerHTML = Math.round(endMargin * 1000) /1000;

		            var midMarginOrigin = document.getElementById("MMO");
		            	midMarginOrigin.innerHTML = Math.round(midMargin * 1000) /1000;
             }


		}

		allArtsWidths(art);
		Margins();
		upperX(art);
		leftCornerCords(art);
		findPegPoint(art);
		dynamicRectangles();
		 
</script>


{% endblock %}
